name: Python Code Quality & Security

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write  # For CodeQL

jobs:
  lint-and-format:
    name: Lint and Format Check
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.8", "3.9", "3.10", "3.11"]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install black pylint flake8 mypy bandit

    - name: Check formatting with Black
      run: |
        black --check --line-length 120 chat_to_markdown.py

    - name: Lint with Pylint
      run: |
        pylint --max-line-length=120 --disable=C0114,C0116,R0913,R0912,R0915 chat_to_markdown.py --exit-zero

    - name: Lint with Flake8
      run: |
        flake8 chat_to_markdown.py --max-line-length=120 --extend-ignore=E203,W503

    - name: Type check with mypy
      run: |
        mypy --ignore-missing-imports chat_to_markdown.py --no-error-summary || echo "Type checking completed with warnings"

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install Bandit
      run: |
        python -m pip install --upgrade pip
        pip install bandit[toml]

    - name: Run Bandit security scan
      run: |
        bandit -r . -f json -o bandit-report.json || true
        bandit -r . || true

    - name: Upload Bandit results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: bandit-report
        path: bandit-report.json

  codeql-analysis:
    name: CodeQL Security Analysis
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: python

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3

  functional-test:
    name: Functional Testing
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.7", "3.8", "3.9", "3.10", "3.11"]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Test script execution
      run: |
        python chat_to_markdown.py --help

    - name: Test with sample file
      run: |
        python chat_to_markdown.py samples/chat.json /tmp/test_output.md
        if [ ! -f /tmp/test_output.md ]; then
          echo "Output file was not created"
          exit 1
        fi
        echo "✓ Conversion successful"

    - name: Test input validation (file size)
      run: |
        # Create a test to ensure validation works
        python -c "
import os
import sys
sys.path.insert(0, '.')
from chat_to_markdown import validate_file_size
try:
    validate_file_size('samples/chat.json')
    print('✓ File size validation works')
except Exception as e:
    print(f'✗ Validation failed: {e}')
    sys.exit(1)
        "

    - name: Test path sanitization
      run: |
        python -c "
import sys
sys.path.insert(0, '.')
from chat_to_markdown import sanitize_file_path
result = sanitize_file_path('../../etc/passwd')
assert result == 'passwd', f'Expected passwd, got {result}'
print('✓ Path sanitization works')
        "

  dependency-check:
    name: Check Dependencies
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Verify no external dependencies
      run: |
        # This project should have no external dependencies
        if [ -f requirements.txt ]; then
          DEPS=$(grep -v '^#' requirements.txt | grep -v '^$' || true)
          if [ -n "$DEPS" ]; then
            echo "Warning: External dependencies found"
            echo "$DEPS"
          else
            echo "✓ No external dependencies - using only standard library"
          fi
        fi

  code-coverage:
    name: Code Coverage Report
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Generate coverage report
      run: |
        echo "✓ Basic functional tests passing"
        echo "Note: Add pytest and coverage tools for detailed reports"
      continue-on-error: true
